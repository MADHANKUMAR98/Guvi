package presentation;

import pojo.Customer;
import service.CustomerService;
import service.CustomerServiceImpl;

import java.util.Collection;
import java.util.Map;
import java.util.Scanner;
import java.util.UUID;
import java.util.InputMismatchException;
import java.util.NoSuchElementException;
import java.util.IllegalArgumentException;
import java.util.NullPointerException;
import java.util.ArithmeticException;
import java.util.IndexOutOfBoundsException;

public class Presentation {

    Scanner scan = new Scanner(System.in);
    private CustomerService customerService = new CustomerServiceImpl();
    private boolean isAdminLoggedIn = false;
    private boolean isCustomerLoggedIn = false;
    private String loggedInCustomerId = null;

    public void present() {
        System.out.println("Welcome to the Electricity Billing System!");
        while (true) {
            try {
                System.out.println("1. Admin Login");
                System.out.println("2. Customer Login");
                System.out.println("3. Customer Register");
                System.out.println("4. Exit");
                System.out.print("Enter your choice: ");
                int choice = scan.nextInt();
                scan.nextLine(); // Consume newline

                switch (choice) {
                    case 1:
                        adminLogin();
                        break;
                    case 2:
                        customerLogin();
                        break;
                    case 3:
                        customerRegister();
                        break;
                    case 4:
                        System.out.println("Exiting...");
                        scan.close();
                        return;
                    default:
                        System.out.println("Invalid choice. Please try again.");
                }
            } catch (InputMismatchException e) {
                System.out.println("Invalid input type. Please enter a number.");
                scan.nextLine(); // Clear scanner buffer
            } catch (Exception e) {
                System.out.println("An unexpected error occurred: " + e.getMessage());
            }
        }
    }

    private void adminLogin() {
        try {
            System.out.print("Enter Admin ID: ");
            String adminId = scan.nextLine();
            System.out.print("Enter Password: ");
            String password = scan.nextLine();

            if ("admin1".equals(adminId) && "1234".equals(password)) {
                isAdminLoggedIn = true;
                adminMenu();
            } else {
                System.out.println("Invalid Admin credentials.");
            }
        } catch (Exception e) {
            System.out.println("An error occurred during admin login: " + e.getMessage());
        }
    }

    private void adminMenu() {
        while (isAdminLoggedIn) {
            try {
                System.out.println("Admin Menu:");
                System.out.println("1. Add Customer");
                System.out.println("2. View All Customers");
                System.out.println("3. Edit Customer");
                System.out.println("4. Delete Customer");
                System.out.println("5. View Pending Bills");
                System.out.println("6. Logout");
                System.out.print("Enter your choice: ");
                int choice = scan.nextInt();
                scan.nextLine(); // Consume newline

                switch (choice) {
                    case 1:
                        addCustomer();
                        break;
                    case 2:
                        viewAllCustomers();
                        break;
                    case 3:
                        editCustomer();
                        break;
                    case 4:
                        deleteCustomer();
                        break;
                    case 5:
                        viewPendingBills();
                        break;
                    case 6:
                        isAdminLoggedIn = false;
                        break;
                    default:
                        System.out.println("Invalid choice. Please try again.");
                }
            } catch (InputMismatchException e) {
                System.out.println("Invalid input type. Please enter a number.");
                scan.nextLine(); // Clear scanner buffer
            } catch (Exception e) {
                System.out.println("An unexpected error occurred: " + e.getMessage());
            }
        }
    }

    private void addCustomer() {
        try {
            System.out.print("Enter name: ");
            String name = scan.nextLine();
            System.out.print("Enter address: ");
            String address = scan.nextLine();
            System.out.print("Enter meter number: ");
            String meterNumber = scan.nextLine();
            System.out.print("Enter password: ");
            String password = scan.nextLine();

            UUID uuid = UUID.randomUUID();
            String id = uuid.toString().replaceAll("-", "").toUpperCase().substring(0, 8);

            Customer newCustomer = new Customer(id, name, address, meterNumber, password);
            customerService.addCustomer(newCustomer);
            System.out.println("Customer added with ID: " + id);
        } catch (IllegalArgumentException e) {
            System.out.println("Invalid input. Please try again.");
        } catch (Exception e) {
            System.out.println("An error occurred while adding the customer: " + e.getMessage());
        }
    }

    private void viewAllCustomers() {
        try {
            Collection<Customer> customers = customerService.fetchAllCustomers();
            System.out.println("All Customers:");
            for (Customer customer : customers) {
                System.out.println(customer);
            }
        } catch (Exception e) {
            System.out.println("An error occurred while fetching customers: " + e.getMessage());
        }
    }

    private void editCustomer() {
        try {
            System.out.print("Enter customer ID to edit: ");
            String customerId = scan.nextLine();

            Customer customer = customerService.fetchCustomer(customerId);
            if (customer != null) {
                System.out.println("Current Information: " + customer);

                System.out.print("Enter new name (or leave blank to keep current): ");
                String newName = scan.nextLine();
                if (!newName.isEmpty()) {
                    customer.setName(newName);
                }

                System.out.print("Enter new address (or leave blank to keep current): ");
                String newAddress = scan.nextLine();
                if (!newAddress.isEmpty()) {
                    customer.setAddress(newAddress);
                }

                System.out.print("Enter new meter number (or leave blank to keep current): ");
                String newMeterNumber = scan.nextLine();
                if (!newMeterNumber.isEmpty()) {
                    customer.setMeterNumber(newMeterNumber);
                }

                System.out.print("Enter new password (or leave blank to keep current): ");
                String newPassword = scan.nextLine();
                if (!newPassword.isEmpty()) {
                    customer.setPassword(newPassword);
                }

                customerService.updateCustomer(customer);
                System.out.println("Customer information updated.");
            } else {
                System.out.println("Customer not found.");
            }
        } catch (NoSuchElementException e) {
            System.out.println("Invalid customer ID.");
        } catch (Exception e) {
            System.out.println("An error occurred while editing the customer: " + e.getMessage());
        }
    }

    private void deleteCustomer() {
        try {
            System.out.print("Enter customer ID to delete: ");
            String customerId = scan.nextLine();

            customerService.deleteCustomer(customerId);
            System.out.println("Customer deleted.");
        } catch (NoSuchElementException e) {
            System.out.println("Invalid customer ID.");
        } catch (Exception e) {
            System.out.println("An error occurred while deleting the customer: " + e.getMessage());
        }
    }

    private void viewPendingBills() {
        try {
            System.out.print("Enter customer ID to view pending bills: ");
            String customerId = scan.nextLine();

            Customer customer = customerService.fetchCustomer(customerId);
            if (customer != null) {
                System.out.println("Pending Bills:");
                Map<String, Double> bills = customer.getBills();

                bills.forEach((month, amount) -> {
                    if (amount > 0) {
                        System.out.println("Month: " + month + ", Amount: Rs " + amount);
                    }
                });
            } else {
                System.out.println("Customer not found.");
            }
        } catch (NoSuchElementException e) {
            System.out.println("Invalid customer ID.");
        } catch (NullPointerException e) {
            System.out.println("No pending bills found for this customer.");
        } catch (Exception e) {
            System.out.println("An error occurred while viewing pending bills: " + e.getMessage());
        }
    }

    private void customerLogin() {
        try {
            System.out.print("Enter Customer ID: ");
            String customerId = scan.nextLine();
            System.out.print("Enter Password: ");
            String password = scan.nextLine();

            Customer customer = customerService.fetchCustomer(customerId);
            if (customer != null && customer.getPassword().equals(password)) {
                loggedInCustomerId = customerId;
                isCustomerLoggedIn = true;
                customerMenu();
            } else {
                System.out.println("Invalid customer credentials.");
            }
        } catch (NoSuchElementException e) {
            System.out.println("Invalid customer ID.");
        } catch (NullPointerException e) {
            System.out.println("Customer not found.");
        } catch (Exception e) {
            System.out.println("An error occurred during customer login: " + e.getMessage());
        }
    }

    private void customerRegister() {
        try {
            System.out.print("Enter name: ");
            String name = scan.nextLine();
            System.out.print("Enter address: ");
            String address = scan.nextLine();
            System.out.print("Enter meter number: ");
            String meterNumber = scan.nextLine();
            System.out.print("Enter password: ");
            String password = scan.nextLine();

            UUID uuid = UUID.randomUUID();
            String id = uuid.toString().replaceAll("-", "").toUpperCase().substring(0, 8);

            Customer newCustomer = new Customer(id, name, address, meterNumber, password);
            customerService.addCustomer(newCustomer);
            System.out.println("Customer registered with
            System.out.println("Customer registered with ID: " + id);
        } catch (IllegalArgumentException e) {
            System.out.println("Invalid input. Please try again.");
        } catch (Exception e) {
            System.out.println("An error occurred during customer registration: " + e.getMessage());
        }
    }

    private void customerMenu() {
        while (isCustomerLoggedIn) {
            try {
                System.out.println("Customer Menu:");
                System.out.println("1. Enter Electricity Usage");
                System.out.println("2. View Previous Bills");
                System.out.println("3. Make Payment");
                System.out.println("4. View Payment History");
                System.out.println("5. Logout");
                System.out.print("Enter your choice: ");
                int choice = scan.nextInt();
                scan.nextLine(); // Consume newline

                switch (choice) {
                    case 1:
                        enterElectricityUsage();
                        break;
                    case 2:
                        viewPreviousBills();
                        break;
                    case 3:
                        makePayment();
                        break;
                    case 4:
                        viewPaymentHistory();
                        break;
                    case 5:
                        isCustomerLoggedIn = false;
                        loggedInCustomerId = null;
                        break;
                    default:
                        System.out.println("Invalid choice. Please try again.");
                }
            } catch (InputMismatchException e) {
                System.out.println("Invalid input type. Please enter a number.");
                scan.nextLine(); // Clear scanner buffer
            } catch (Exception e) {
                System.out.println("An unexpected error occurred: " + e.getMessage());
            }
        }
    }

    private void enterElectricityUsage() {
        try {
            System.out.print("Enter month (e.g., 'January'): ");
            String month = scan.nextLine();
            System.out.print("Enter electricity used (in kWh): ");
            double usage = scan.nextDouble();
            scan.nextLine(); // Consume newline

            Customer customer = customerService.fetchCustomer(loggedInCustomerId);
            if (customer != null) {
                double billAmount = usage * 5; // Example calculation, Rs 5 per kWh
                customer.getBills().put(month, billAmount);
                customerService.updateCustomer(customer);
                System.out.println("Electricity usage recorded. Bill for " + month + ": Rs " + billAmount);
            } else {
                System.out.println("Customer not found.");
            }
        } catch (NullPointerException e) {
            System.out.println("Customer record is incomplete or missing.");
        } catch (ArithmeticException e) {
            System.out.println("An arithmetic error occurred while calculating the bill. Please try again.");
        } catch (Exception e) {
            System.out.println("An error occurred while entering electricity usage: " + e.getMessage());
        }
    }

    private void viewPreviousBills() {
        try {
            Customer customer = customerService.fetchCustomer(loggedInCustomerId);
            if (customer != null) {
                System.out.println("Previous Bills:");
                for (Map.Entry<String, Double> entry : customer.getBills().entrySet()) {
                    System.out.println("Month: " + entry.getKey() + ", Amount: Rs " + entry.getValue());
                }
            } else {
                System.out.println("Customer not found.");
            }
        } catch (NullPointerException e) {
            System.out.println("Customer record is incomplete or missing.");
        } catch (Exception e) {
            System.out.println("An error occurred while viewing previous bills: " + e.getMessage());
        }
    }

    private void makePayment() {
        try {
            Customer customer = customerService.fetchCustomer(loggedInCustomerId);
            if (customer != null) {
                System.out.println("Pending Bills:");
                for (Map.Entry<String, Double> entry : customer.getBills().entrySet()) {
                    if (entry.getValue() > 0) {
                        System.out.println("Month: " + entry.getKey() + ", Amount: Rs " + entry.getValue());
                    }
                }

                System.out.print("Enter the month you want to pay for: ");
                String month = scan.nextLine();

                if (customer.getBills().containsKey(month)) {
                    double amountDue = customer.getBills().get(month);
                    if (amountDue > 0) {
                        System.out.print("Enter payment amount: ");
                        double payment = scan.nextDouble();
                        scan.nextLine(); // Consume newline

                        if (payment >= amountDue) {
                            customer.getBills().put(month, 0.0);
                            customer.getPaymentHistory().put(month, amountDue);
                            customerService.updateCustomer(customer);
                            System.out.println("Payment successful. Full payment for " + month + " is made.");
                        } else {
                            System.out.println("Insufficient payment. Please pay the full amount.");
                        }
                    } else {
                        System.out.println("No pending bill for the selected month.");
                    }
                } else {
                    System.out.println("Invalid month selected.");
                }
            } else {
                System.out.println("Customer not found.");
            }
        } catch (InputMismatchException e) {
            System.out.println("Invalid input type. Please enter a valid number.");
            scan.nextLine(); // Clear scanner buffer
        } catch (NullPointerException e) {
            System.out.println("Customer record is incomplete or missing.");
        } catch (IndexOutOfBoundsException e) {
            System.out.println("Invalid month index provided.");
        } catch (Exception e) {
            System.out.println("An error occurred while processing the payment: " + e.getMessage());
        }
    }

    private void viewPaymentHistory() {
        try {
            Customer customer = customerService.fetchCustomer(loggedInCustomerId);
            if (customer != null) {
                System.out.println("Payment History:");
                for (Map.Entry<String, Double> entry : customer.getPaymentHistory().entrySet()) {
                    System.out.println("Month: " + entry.getKey() + ", Paid Amount: Rs " + entry.getValue());
                }
            } else {
                System.out.println("Customer not found.");
            }
        } catch (NullPointerException e) {
            System.out.println("Customer record is incomplete or missing.");
        } catch (Exception e) {
            System.out.println("An error occurred while viewing payment history: " + e.getMessage());
        }
    }
}
System.out.println("********************************************");
System.out.println("*                                          *");
System.out.println("*       WELCOME TO THE ELECTRICITY         *");
System.out.println("*         BILLING SYSTEM                   *");
System.out.println("*                                          *");
System.out.println("********************************************");
System.out.println("**          Powering Your Future          **");
System.out.println("********************************************");
System.out.println();
